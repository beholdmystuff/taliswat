<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
body
{
    margin: 0;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
}
.hidden
{
    display: none;
}
/* MAIN MENU */
.mainMenu
{
    width: 100%;
    height: 100%;
    background-color: black;
}
.logo
{
    width: 30vw;
    height: 15vw;
    left: 35vw;
    position: absolute;
    background-image: url(assets/ui/logo.png);
    background-size: 100% 100%;
    animation: logoSkew 15s infinite;
    animation-timing-function: ease-in-out;
}
@keyframes logoSkew
{
    0% { transform: skew(0deg); }
    25% { transform: skew(5deg); }
    75% { transform: skew(-5deg); }
    100% { transform: skew(0deg); }
}

@font-face
{
  font-family: Caxton;
  src: url(assets/fonts/CaxtonStd-Book.otf);
}

@font-face
{
  font-family: Windlass;
  src: url(assets/fonts/Windlass.ttf);
}

.gameList
{
    width: 60vw;
    left: 20vw;
    position: absolute;
    height: 25vw;
    top: 17.5vw;
    overflow-x: hidden;
    overflow-y: auto;
    user-select: none;
}
.loadGame, .openGame
{
    display: inline-block;
    font-family: Windlass;
    border-radius: 1vw;
    border: 0px;
    margin: 0.5vw 0vw 0.5vw 0vw;
    line-height: 2vw;
    cursor: pointer;
    width: 98%;
    font-size: 1vw;
}
.loadGame:hover
{
    animation: openGameHover 3s infinite;
}
@keyframes openGameHover
{
    0% { background-color: #3ed33e99; }
    50% { background-color: #3ed33ecc; }
    100% { background-color: #3ed33e99; }
}
.openGame:hover
{
    animation: savedGameHover 3s infinite;
}
@keyframes savedGameHover
{
    0% { background-color: #64d5f299; }
    50% { background-color: #64d5f2cc; }
    100% { background-color: #64d5f299; }
}
.loadGame
{
    background-color: #3ed33e99;
}
.openGame
{
    background-color: #64d5f299;
}
.loadGame div, .openGame div
{
    display: inline-block;
    text-align: center;
    pointer-events: none;
    user-select: none;
}
.gameTypeIcon
{
    width: 5%;
}
.gameOwner
{
    width: 30%;
}
.gameSlots
{
    width: 35%;
}
.gameStatus
{
    width: 30%;
}

/* GAME LOBBY */
.gameLobby
{

}
.gameSlotsContainer
{
    user-select: none;
    width: 60vw;
    left: 20vw;
    position: absolute;
    height: 25vw;
    top: 17.5vw;
}
.gameSlot
{
    display: inline-block;
    font-family: Windlass;
    border-radius: 1vw;
    border: 0px;
    margin: 0.25vw 0vw 0.25vw 0vw;
    line-height: 3vw;
    width: 98%;
    font-size: 1vw;
    background: #c0c0c099;
    z-index: 5;
    transition: background-color 0.25s linear;
    height: 3vw;
}
.gameSlot:hover
{
    background-color: #c0c0c0cc;
}
.gameSlot div, .gameSlot div
{
    display: block;
    text-align: center;
}
.slotPlayerName
{
    position: absolute;
    left: 0%;
    pointer-events: none;
    width: 40%;
}
.slotCharPic
{
    position: absolute;
    left: 40%;
    background-size: 22.5% 100%;
    background-repeat: no-repeat;
    background-position: center;
    width: 25%;
    min-height: 3vw;
}
.clickable
{
    cursor: pointer;
}
.slotCharName
{
    position: absolute;
    left: 65%;
    pointer-events: none;
    width: 35%;
}

/* CHARACTER SELECTOR */
.characterSelector
{
    width: 100vw;
    height: 100vw;
    position: absolute;
    background-color: black;
    z-index: 4;
    top: 0;
    left: 0;
}

.characterPicker
{
    width: 100vw;
    height: 17vw;
    overflow-x: scroll;
    overflow-y: hidden;
    white-space: nowrap;
    top:  8vw;
    position: absolute;
}
.nameSearchInput
{
    position: absolute;
    left: 42.5vw;
    top: 3vw;
    width: 15vw;
    font-family: Windlass;
    font-size: 1.2vw;
    line-height: 2vw;
    background-color: transparent;
    border: 0px;
    outline: none;
    background-image: url(assets/ui/paper_title.png);
    background-size: 100% 100%;
    text-align: center;
}
.nameSearchLabel
{
    position: absolute;
    left: 26.5vw;
    top: 3.2vw;
    width: 16vw;
    color: white;
    font-family: Windlass;
    font-size: 1.2vw;
    line-height: 2vw;
}

.charSelectorCharContainer
{
    display: inline-block;
    width: 10vw;
    height: 15vw;
    margin: 0vw 1vw 0vw 1vw;
    padding: 0.5vw 1vw 1vw 1vw;
    transition: background-color 0.3s ease-out, opacity 0.2s linear;
    border-radius: 2vw;
    cursor: pointer;
    background-size: 100% 100%;
    opacity: 1;
}
.charSelectorCharContainer:hover
{
    background-color: #64d5f299;
}
.characterSelectorMini
{
    width: inherit;
    height: inherit;
    pointer-events: none;
}
.characterSelectorName
{
    width: 13vw;
    height: 2vw;
    position: relative;
    left: -1.5vw;
    font-family: Windlass;
    font-size: 1.2vw;
    line-height: 2vw;
    background-image: url(assets/ui/paper_title.png);
    background-size: 100% 100%;
    text-align: center;
    pointer-events: none;
}
.characterSelectorDescription
{
    top: 25.5vw;
    left: 30vw;
    width: 40vw;
    height: 20vw;
    text-align: center;
    pointer-events: none;
    background-image: url(assets/ui/paper.png);
    background-size: 100% 100%;
    z-index: 5;
    position: absolute;
    font-family: Caxton;
    font-size: 0.8vw;
    line-height: 1vw;
    white-space: pre-wrap;
    padding: 1vw 2vw 0vw 2vw;
}

/* CONTAINERS */
#gameMap
{
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    background-image: url(bg.jpg);
    background-size: 100% 100%;
}
#gameMapInner div
{
    position: absolute;
    outline: none;
    border: 0px;
}
#gameMapInner
{
    width: 6353px;
    height: 3792px;
    cursor: grab;
    user-select: none;
    transform-origin: center;
}
/* BOARD MAPS*/
.boardBase
{
    width: 4096px;
    height: 2048px;
    top: 885px;
    left: 1114px;
    z-index: 2;
    background-size: 100% 100%;
}
.boardExpansion
{
    width: 2560px;
    height: 1792px;
    z-index: 1;
    background-size: 100% 100%;
}
.boardWoodlands
{
    top: 1990px;
    left: 3790px;
}
.boardCity
{
    top: 0px;
    left: 0px;
}
.boardDungeon
{
    top: 0px;
    left: 3790px;
}
.boardHighlands
{
    top: 1990px;
    left: 0px;
}
/* BASE BOARD SPACES */
.space
{
    position: absolute;
    opacity: 0.0;
    cursor: pointer;
    transition: opacity 0.3s ease-in-out;
    animation: fadeOut 0.5s;
}
.space:hover
{
    opacity: 0.5;
    animation: fadeIn 1s infinite;
}
@keyframes fadeIn
{
    0% {opacity: 0.5}
    50% {opacity: 0.75}
    100% {opacity: 0.5}
}
@keyframes fadeOut
{
    0% {opacity: 0.5}
    100% {opacity: 0.0}
}

.charCard
{
    width: 1230px;
    height: 815px;
    top: 2048px;
    left: 1446px;
    background-size: 100% 100%;
}

.citySpace
{
    width: 555px;
    height: 300px;
    top: 33px;
    left: 44px;
}
.fields1Space
{
    width: 585px;
    height: 300px;
    top: 33px;
    left: 595px;
}
.hillsSpace
{
    width: 577px;
    height: 300px;
    top: 33px;
    left: 1178px;
}
.plains1Space
{
    width: 577px;
    height: 300px;
    top: 33px;
    left: 1754px;
}
.woodsSpace
{
    width: 570px;
    height: 300px;
    top: 33px;
    left: 2331px;
}
.plains2Space
{
    width: 585px;
    height: 300px;
    top: 33px;
    left: 2901px;
}
.tavernSpace
{
    width: 570px;
    height: 315px;
    top: 33px;
    left: 3486px;
}
.fields2Space
{
    width: 450px;
    height: 288px;
    top: 348px;
    left: 3605px;
}
.ruinsSpace
{
    width: 450px;
    height: 272px;
    top: 634px;
    left: 3605px;
}
.plains3Space
{
    width: 450px;
    height: 272px;
    top: 906px;
    left: 3605px;
}
.forest3Space
{
    width: 450px;
    height: 272px;
    top: 1178px;
    left: 3605px;
}
.fields3Space
{
    width: 450px;
    height: 272px;
    top: 1450px;
    left: 3605px;
}
.villageSpace
{
    width: 568px;
    height: 280px;
    top: 1735px;
    left: 3485px;
}
.fields4Space
{
    width: 586px;
    height: 280px;
    top: 1735px;
    left: 2901px;
}
.graveyardSpace
{
    width: 575px;
    height: 280px;
    top: 1735px;
    left: 2328px;
}
.woods2Space
{
    width: 575px;
    height: 280px;
    top: 1735px;
    left: 1756px;
}
.sentinelSpace
{
    width: 575px;
    height: 280px;
    top: 1735px;
    left: 1181px;
}
.hills2Space
{
    width: 585px;
    height: 280px;
    top: 1735px;
    left: 598px;
}
.chapelSpace
{
    width: 555px;
    height: 280px;
    top: 1735px;
    left: 45px;
}
.fields5Space
{
    width: 405px;
    height: 285px;
    top: 1450px;
    left: 45px;
}
.cragsSpace
{
    width: 405px;
    height: 272px;
    top: 1179px;
    left: 45px;
}
.plains4Space
{
    width: 405px;
    height: 290px;
    top: 890px;
    left: 45px;
}
.woods3Space
{
    width: 405px;
    height: 260px;
    top: 630px;
    left: 45px;
}
.fields6Space
{
    width: 405px;
    height: 260px;
    top: 380px;
    left: 45px;
}
/* SPACE HIHGLIGHT */
.topLeftHighlight
{
    background-image: url(assets/board/glow/tl.png);
    background-position: center;
    background-size: 100% 100%;
    width: 25%;
    height: 25%;
    top: 0px;
    left: 0px;
}
.topHighlight
{
    background-image: url(assets/board/glow/t.png);
    background-position: center;
    background-size: 100% 100%;
    width: 50%;
    height: 25%;
    top: 0px;
    left: 25%;
}
.topRightHighlight
{
    background-image: url(assets/board/glow/tr.png);
    background-position: center;
    background-size: 100% 100%;
    width: 25%;
    height: 25%;
    top: 0px;
    right: 0px;
}
.rightHighlight
{
    background-image: url(assets/board/glow/r.png);
    background-position: center;
    background-size: 100% 100%;
    width: 25%;
    height: 50%;
    top: 25%;
    right: 0px;
}
.bottomRightHighlight
{
    background-image: url(assets/board/glow/br.png);
    background-position: center;
    background-size: 100% 100%;
    width: 25%;
    height: 25%;
    bottom: 0px;
    right: 0px;
}
.bottomHighlight
{
    background-image: url(assets/board/glow/b.png);
    background-position: center;
    background-size: 100% 100%;
    width: 50%;
    height: 25%;
    bottom: 0px;
    right: 25%;
}
.bottomLeftHighlight
{
    background-image: url(assets/board/glow/bl.png);
    background-position: center;
    background-size: 100% 100%;
    width: 25%;
    height: 25%;
    top: 75%;
    left: 0px;
}
.LeftHighlight
{
    background-image: url(assets/board/glow/l.png);
    background-position: center;
    background-size: 100% 100%;
    width: 25%;
    height: 50%;
    bottom: 25%;
    left: 0px;
}
</style>
</head>
<body>
<!-- OPEN MAIN MENU AFTER LOGIN -->
<!-- <div class="mainMenu">
    <div class="logo"></div>
    <div class="gameList"></div>
</div> -->


<div id="gameMap"><div id="gameMapInner">
    <div class="boardBase">
        <!-- CHARACTER CARD -->
        <div class="charCard"></div>
        <!-- OUTER RING -->
        <div class="space citySpace"></div>
        <div class="space fields1Space"></div>
        <div class="space hillsSpace"></div>
        <div class="space plains1Space"></div>
        <div class="space woodsSpace"></div>
        <div class="space plains2Space"></div>
        <div class="space tavernSpace"></div>
        <div class="space fields2Space"></div>
        <div class="space ruinsSpace"></div>
        <div class="space plains3Space"></div>
        <div class="space forest3Space"></div>
        <div class="space fields3Space"></div>
        <div class="space villageSpace"></div>
        <div class="space fields4Space"></div>
        <div class="space graveyardSpace"></div>
        <div class="space woods2Space"></div>
        <div class="space sentinelSpace"></div>
        <div class="space hills2Space"></div>
        <div class="space chapelSpace"></div>
        <div class="space fields5Space"></div>
        <div class="space cragsSpace"></div>
        <div class="space plains4Space"></div>
        <div class="space woods3Space"></div>
        <div class="space fields6Space"></div>
        <!-- MIDDLE RING -->
        <div class="space warlocksCaveSpace"></div>
        <div class="space desert1Space"></div>
        <div class="space oasisSpace"></div>
        <div class="space desert2Space"></div>
        <div class="space templeSpace"></div>
        <div class="space woodsSpace"></div>
        <div class="space runesSpace"></div>
        <div class="space castleSpace"></div>
        <div class="space portalOfPowerSpace"></div>
        <div class="space blackKnightSpace"></div>
        <div class="space hiddenValleySpace"></div>
        <div class="space hillsSpace"></div>
        <div class="space cursedGladeSpace"></div>
        <div class="space runes2Space"></div>
        <div class="space chasmSpace"></div>
        <div class="space runes3Space"></div>
        <!-- INNER RING -->
        <div class="space valleyOfFireSpace"></div>
        <div class="space werewolfDenSpace"></div>
        <div class="space deathSpace"></div>
        <div class="space cryptSpace"></div>
        <div class="space plainOfPerilSpace"></div>
        <div class="space minesSpace"></div>
        <div class="space vampiresTowerSpace"></div>
        <div class="space pitsSpace"></div>
        <div class="space crownOfCommandSpace"></div>
    </div>
    <div class="boardExpansion boardWoodlands">
    </div>
    <div class="boardExpansion boardCity">
    </div>
    <div class="boardExpansion boardDungeon">
    </div>
    <div class="boardExpansion boardHighlands">
    </div>
</div></div>
<!-- OPEN GAME LOBBY AFTER SUCCESSFULLY JOINING A GAME -->
<div class="gameLobby">
    <div class="gameSlotsContainer"></div>
</div>
</body>
<!-- TODO merge game data into single json -->
<script src="assets/text/expansions.js"></script>
<script src="assets/text/spaces.js"></script>
<script src="assets/text/chars.js"></script>
<script>
function fetch(url, type)
{
    return new Promise((resolve, reject)=>
    {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);

        if (type)
            xhr.responseType = type;

        xhr.addEventListener("load", function ()
        {
            if (xhr.status !== 200)
                resolve(false);
            else
                resolve(xhr.response);

        }, false);
        xhr.send();
    });
}
var storage = {};

function storageInit(db, storeList)
{
    let indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
    let dbRequest = indexedDB.open(db);

    dbRequest.onupgradeneeded = function(event)
    {
        let db = event.target.result;
        storeList.forEach(function(store)
        {
            if (!db.objectStoreNames.contains(store))
                db.createObjectStore(store);
        });
        db.close();
    }
}

function storageDisconnect(db)
{
    return new Promise(resolve =>
    {
        storage[db].close();
        delete storage[db];
        resolve();
    });
}

function storageConnect(db, version)
{
    return new Promise(function(resolve, reject)
    {
        try
        {
            let indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

            if (db in storage)
                resolve(storage[db]); //do not connect if already connected

            let dbRequest;
            if (version)
                dbRequest = indexedDB.open(db, version);
            else
                dbRequest = indexedDB.open(db);

            dbRequest.onerror = function(event)
            {
                console.log(event);
                reject(event);
            };

            dbRequest.onsuccess = function(event)
            {
                storage[db] = event.target.result;
                resolve(true);
            };
        }
        catch (error)
        {
            console.log(error);
            reject(error);
        }
    });
}

function storageExists(cmd)
{
    return new Promise(function(resolve, reject)
    {
        try
        {
            let db = storage[cmd.dbName];
            let nameExists = db.objectStoreNames.contains(cmd.store);
            if (nameExists)
            {
                let transaction = db.transaction([cmd.store], 'readwrite');
                let objectStore = transaction.objectStore(cmd.store);
                let objectRequest = objectStore.get(cmd.name);

                objectRequest.onerror = function(event)
                {
                    console.log(event);
                    resolve(false);
                };

                objectRequest.onsuccess = function(event)
                {
                    resolve(event.target.result ? true : false);
                };
            }

        }
        catch (error)
        {
            console.log(error);
            reject(error);
        }
    });
}

function storageGet(cmd)
{
    return new Promise(function(resolve, reject)
    {
        let transaction;
        try
        {
            transaction = storage[cmd.dbName].transaction([cmd.store], 'readonly');
        }
        catch (error)
        {
            console.log(error);
            if (!transaction)
            {
                resolve(event);
            }
        }
        finally
        {
            let objectStore = transaction.objectStore(cmd.store);
            let objectRequest = objectStore.get(cmd.name); // Overwrite if exists

            objectRequest.onerror = function(event)
            {
                console.log(event);
                resolve(event);
            };

            objectRequest.onsuccess = function(event)
            {
                resolve(objectRequest.result);
            };
        }
    });
}

function storagePut(cmd)
{
    return new Promise(async function(resolve, reject)
    {
        let transaction = storage[cmd.dbName].transaction([cmd.store], 'readwrite');
        let objectStore = transaction.objectStore(cmd.store);
        let objectRequest = objectStore.put(cmd.data, cmd.name);
        console.log(objectStore.indexNames);
        objectRequest.onerror = function(event)
        {
            reject(event);
        };

        objectRequest.onsuccess = function(event)
        {
            console.log(event);
            resolve(event.target.result);
        };
    });
}

/* GAME MAP */
let dragging = false;
let rotating = false;
let gameMap = document.querySelector("#gameMap");
let gameMapInner = gameMap.querySelector("#gameMapInner");
let computedStyle = window.getComputedStyle(gameMapInner);
let innerWidth = parseInt(window.getComputedStyle(gameMapInner).width.replace("px", ""));
let innerHeight = parseInt(window.getComputedStyle(gameMapInner).height.replace("px", ""));
let transform = {translate: [innerWidth*-0.35, innerHeight*-0.37], scale: 0.4, rotate: 0}
function setTransform()
{
    gameMapInner.style.setProperty("transform", "translate3d(" + transform.translate[0] + "px," + transform.translate[1] + "px, 0px) scale(" + transform.scale + ") rotate(" + Math.round(transform.rotate/5)*5 + "deg)");
}
// gameMapInner.style.setProperty("transform-origin", "center");
setTransform();
// gameMapInner.style.setProperty("transform-origin", "100% 50%");

function capMovement()
{
    if (transform.translate[0] > 250)
        transform.translate[0] = 250;
    if (transform.translate[0] < -4346)
        transform.translate[0] = -4346;
    if (transform.translate[1] > 250)
        transform.translate[1] = 250;
    if (transform.translate[1] < -2810)
        transform.translate[1] = -2810;
}

function moveMap(event)
{
    transform.translate[0] += event.movementX * (2.5 * transform.scale);
    transform.translate[1] += event.movementY * (2.5 * transform.scale);

    capMovement()
    setTransform();
}
function rotateMap(event)
{
    let x = event.clientX; //x position in viewport
    let y = event.clientY;  //y position in viewport
    let center = {x: (window.innerWidth)/2, y: (window.innerHeight) /2};
    let translateDelta = {x: x - center.x, y: y - center.y};

    console.log(translateDelta.x)

    if (translateDelta.x < 0)
        transform.rotate += (event.movementY * -1) * 0.2;
    else
        transform.rotate += event.movementY * 0.2;

    if (translateDelta.y < 0)
        transform.rotate += event.movementX * 0.2;
    else
        transform.rotate += event.movementX * -0.2;

    setTransform();
}

function translateMap(event)
{
    gameMapInner.style.setProperty("transition", "transform 0.0s linear");
    if (dragging && event.ctrlKey)
        rotateMap(event);
    else if (dragging && !event.ctrlKey)
        moveMap(event);
    capMovement();
}
gameMap.addEventListener("mousedown", function(event)
{
    dragging = true;
    gameMapInner.style.setProperty("cursor", "grabbing");
    gameMap.addEventListener("mousemove", translateMap);
});

gameMap.addEventListener("mouseup", function(event)
{
    dragging = false;
    gameMapInner.style.setProperty("cursor", "grab");
});
function wheelZoom(event)
{
    let scaleMin = 0.2;
    let scaleMax = 1;
    transform.scale += (event.deltaY * -0.0005);
    if (transform.scale < scaleMin)
        transform.scale = scaleMin;
    else if (transform.scale > scaleMax)
        transform.scale = scaleMax;

    let x = event.clientX; //x position in viewport
    let y = event.clientY;  //y position in viewport
    let center = {x: (window.innerWidth)/2, y: (window.innerHeight) /2};
    let translateDelta = {x: x - center.x, y: y - center.y};
    let deltaFraction = 0.2;

    if (transform.scale > scaleMin && transform.scale < scaleMax)
    {
        if (event.deltaY < 0) //if zoom in
            transform.translate[1] -= translateDelta.y * (deltaFraction * 1.5);
        else
            transform.translate[1] -= translateDelta.y * (deltaFraction);

        if (event.deltaY < 0)
            transform.translate[0] -= translateDelta.x * deltaFraction;
        else
            transform.translate[0] -= translateDelta.x * deltaFraction;

        capMovement();
    }
    gameMapInner.style.setProperty("transition", "transform 0.1s linear");
    setTransform();
}
document.addEventListener("wheel", wheelZoom); //set da event

async function ass()
{
    //connect db
    await storageInit("Talisman", ["boardAssets", "minisAssets", "buttonsAssets", "tokensAssets"]);
    await storageConnect("Talisman");

    //main board
    let bbReq = {store: "boardAssets", name: "boardBase", dbName: "Talisman"};
    if (!await storageExists(bbReq)) //cache
    {
        let boardBase = await fetch(window.location.origin + "/assets/board/base.png", "blob");
        bbReq.data = boardBase;
        let bbRes = await storagePut(bbReq);
    }

    //load
    let bbRes = await storageGet(bbReq);
    var URL = window.URL || window.webkitURL;
    var bbIMGURL = URL.createObjectURL(bbRes);
    var bbElement = document.querySelector(".boardBase");
    bbElement.style.setProperty("background-image", "url(" + bbIMGURL + ")");


    //
    //
    // //highlands
    // let bhReq = {store: "boardAssets", name: "boardHighlands", database: storage};
    // if (!await storageExists(bhReq)) //cache
    // {
    //     let boardHighlands = await fetch(window.location.origin + "/assets/board/highlands.png", "blob");
    //     bhReq.data = boardHighlands;
    //     let bhRes = await storagePut(bhReq);
    // }
    // let bhRes = await storageGet(bhReq);
    //
    // var bhIMGURL = URL.createObjectURL(bhRes);
    // var bhElement = document.querySelector(".boardExpansion.boardHighlands");
    // bhElement.style.setProperty("background-image", "url(" + bhIMGURL + ")");

    // //city
    // let boardCity = await fetch(window.location.origin + "/assets/board/city.png", "blob");
    // let bcReq = {db: "Talisman", store: "boardAssets", data: boardCity, name: "boardCity"};
    // let bcRes = await storagePut(bcReq);
    // bcRes = await storageGet(bcReq);
    //
    // var bcIMGURL = URL.createObjectURL(bcRes);
    // var bcElement = document.querySelector(".boardExpansion.boardCity");
    // bcElement.style.setProperty("background-image", "url(" + bcIMGURL + ")");
    //
    // //dungeon
    // let boardWoodlands = await fetch(window.location.origin + "/assets/board/woodlands.png", "blob");
    // let bwReq = {db: "Talisman", store: "boardAssets", data: boardWoodlands, name: "boardWoodlands"};
    // let bwRes = await storagePut(bwReq);
    // bwRes = await storageGet(bwReq);
    //
    // var bwIMGURL = URL.createObjectURL(bwRes);
    // var bwElement = document.querySelector(".boardExpansion.boardWoodlands");
    // bwElement.style.setProperty("background-image", "url(" + bwIMGURL + ")");
    //
    // //dungeon
    // let boardDungeon = await fetch(window.location.origin + "/assets/board/dungeon.png", "blob");
    // let bdReq = {db: "Talisman", store: "boardAssets", data: boardDungeon, name: "boardDungeon"};
    // let bdRes = await storagePut(bdReq);
    // bdRes = await storageGet(bdReq);
    //
    // var bdIMGURL = URL.createObjectURL(bdRes);
    // var bdElement = document.querySelector(".boardExpansion.boardDungeon");
    // bdElement.style.setProperty("background-image", "url(" + bdIMGURL + ")");
    //
    // //TODO: precache highlight alphas
    //
    // let charCard = await fetch(window.location.origin + "/assets/chars/char_card.png", "blob");
    // let charCardReq = {db: "Talisman", store: "charAssets", data: charCard, name: "charCard"};
    // console.log(await storageExists(charCardReq));
    //
    // let charCardRes = await storagePut(charCardReq);
    // charCardRes = await storageGet(charCardReq);
    //
    // var charCardIMGURL = URL.createObjectURL(charCardRes);
    // var charCardElement = document.querySelector(".charCard");
    // charCardElement.style.setProperty("background-image", "url(" + charCardIMGURL + ")");

    //TODO: auto db update and store create on put

    //removes image on opera
    // URL.revokeObjectURL(imgURL);


}

document.querySelectorAll(".space").forEach(function(space)
{
    space.addEventListener("mouseenter", function(event)
    {
        let tl = document.createElement("div");
        tl.className = "highlight topLeftHighlight";

        let t = document.createElement("div");
        t.className = "highlight topHighlight";

        let tr = document.createElement("div");
        tr.className = "highlight topRightHighlight";

        let r = document.createElement("div");
        r.className = "highlight rightHighlight";

        let br = document.createElement("div");
        br.className = "highlight bottomRightHighlight";

        let b = document.createElement("div");
        b.className = "highlight bottomHighlight";

        let bl = document.createElement("div");
        bl.className = "highlight bottomLeftHighlight";

        let l = document.createElement("div");
        l.className = "highlight leftHighlight";

        event.target.appendChild(tl);
        event.target.appendChild(t);
        event.target.appendChild(tr);
        event.target.appendChild(t);
        event.target.appendChild(br);
        event.target.appendChild(r);
        event.target.appendChild(b);
        event.target.appendChild(bl);
        event.target.appendChild(l);
    });

    space.addEventListener("mouseleave", function(event)
    {
        setTimeout(function(target)
        {
            target.querySelectorAll(".highlight").forEach(function(highlight)
            {
                highlight.parentNode.removeChild(highlight);
            });
        }, 300, event.target);
    });
});
// ass();
let player = {name: "testboi", id:"123456789"};
let currentGameLobby;
let savedGames = [];
let openGames = [];
let gameDetails =
{
    "asdfghjkl123456789":
    {
        id: "asdfghjkl123456789",
        owner: {name: "testboi", id:"123456789"},
        playerCount: 5,
        slots: 6,
        status: "load",
        turn: 25,
        players: [{name: "testboi", id:"123456789", char: ""},
                {name: "putin", id: "6661", char: "Assassin"},
                {name: "trump", id: "6662", char: "Troll"},
                {name: "xijingping", id: "6663", char: "Dark Cultist"},
                {name: "kimjongun", id: "6664", char: "Barbarian"}],
        rules:
        {
            expansions: ["The Ancient Beasts", "The Blood Moon", "The City",
                        "The Deep Realm", "The Sacred Pool"],
            characters: ["The Ancient Beasts", "The Blood Moon", "The Cataclysm",
                        "The City", "The Clockwork Kingdom", "The Deep Realm",
                        "The Dragon", "The Dungeon", "The Firelands", "The Forstmarch",
                        "The Harbinger", "The Highland", "The Nether Realm", "The Realm of Souls",
                        "The Reaper", "The Sacred Pool", "The Woodland"]
        }
    },
    "987654321lkjhgfdsa":
    {
        id: "987654321lkjhgfdsa",
        owner: {name: "testboi", id:"123456789"},
        playerCount: 4,
        slots: 6,
        status: "fresh",
        turn: 0,
        players: [{name: "testboi", id:"123456789", char: ""},
                {name: "putin", id: "6661"},
                {name: "trump", id: "6662"},
                {name: "kimjongun", id: "6664"}],
        chars: [{name: "", pic: "b", playerid: "123456789"},
                {name: "Assassin", pic: "b", playerid: "6661"},
                {name: "Troll", pic: "b", playerid: "6662"},
                {name: "Barbarian", pic: "b", playerid: "6664"}],
        rules : {expansions : [], characters : []}
    }
}

function fetchSavedGames()
{
    let game =
    {
        id: "asdfghjkl123456789",
        owner: {name: "testboi", id:"123456789"},
        playerCount: 5,
        slots: 6,
        status: "load",
        turn: 25
    }

    console.log(game);
    savedGames.push(game);
    console.log(savedGames);
}

function fetchOpenGames()
{
    let game =
    {
        id: "987654321lkjhgfdsa",
        owner: {name: "testboi", id:"123456789"},
        playerCount: 4,
        slots: 6,
        status: "fresh",
        turn: 0
    };
    openGames.push(game);
}

function openGame(event)
{
    console.log("Game ID:", event);
    console.log("Game ID:", event.target.getAttribute("gameid"));

    //close game list
    //open game lobby

}
// PARSE GAME OBJECT TO ELEMENT
function parseGame(game, type)
{
    let element = document.createElement("div");
    element.className = type + "Game";
    element.setAttribute("gameid", game.id);

    let gameTypeElement = document.createElement("div");
    gameTypeElement.className = "gameTypeIcon";
    gameTypeElement.textContent = (game.status == "fresh") ? "✿" : "♻";

    let ownerElement = document.createElement("div");
    ownerElement.className = "gameOwner";
    ownerElement.textContent = game.owner.name + "'s game";

    let slotsElement = document.createElement("div");
    slotsElement.className = "gameSlots";
    slotsElement.textContent = game.playerCount + " / " + game.slots + " players";

    let statusElement = document.createElement("div");
    statusElement.className = "gameStatus";
    statusElement.textContent = (game.status == "fresh") ? "Not started yet" : (game.turn + " turn load");

    element.addEventListener("click", openGame);

    element.appendChild(gameTypeElement);
    element.appendChild(ownerElement);
    element.appendChild(slotsElement);
    element.appendChild(statusElement);

    return element;
}

// FETCH AVAILABLE GAMES
async function fetchGames()
{
    fetchSavedGames();
    fetchOpenGames();

    let gameListElement = document.querySelector(".gameList");

    //draw saved games
    savedGames.forEach(function(game)
    {
        gameListElement.appendChild(parseGame(game, "load"));
    });

    //draw open games
    openGames.forEach(function(game)
    {
        gameListElement.appendChild(parseGame(game, "open"));
    });
}

function selectCharacter(name)
{
    console.log(name);
    //select char
    console.log(currentGameLobby);
    let slotID;
    for (var i = 0, l = currentGameLobby.players.length; i < l; i++)
    {
        let lobbyPlayer = currentGameLobby.players[i];
        if (lobbyPlayer.name == player.name)
        {
            lobbyPlayer.char = name;
            slotID = i;
        }
    }

    console.log(slotID);
    let slot = document.querySelector(".gameSlot:nth-child(" + slotID + 1  + ")");
    slot.querySelector(".slotCharPic").style.setProperty("background-image", "url(assets/chars/" + ((name != "Random") ? charsSorted[name].filePrefix : "random") + "_p.png)");
    slot.querySelector(".slotCharName").textContent = name;


    let selector = document.querySelector(".characterSelector");
    selector.parentNode.removeChild(selector);
    //close character selector
}

function selectCharacterEvent(event)
{
    selectCharacter(event.target.getAttribute("name"));
}

function searchCharacterName(event)
{
    if (event.keyCode === 13)
    {
        let chars = document.querySelectorAll(".charSelectorCharContainer");

        chars.forEach(function(char)
        {
            if (char.style.getPropertyValue("display") == "inline-block")
                selectCharacter(char.getAttribute("name"));

        });

        event.preventDefault();
        return;
    }

    document.querySelectorAll(".charSelectorCharContainer").forEach(function(mini)
    {
        if (mini.getAttribute("name").toLowerCase().search(event.target.value.toLowerCase()) > -1)
        {
            mini.style.setProperty("opacity", "1");
            mini.style.setProperty("display", "inline-block");
        }
        else
        {
            mini.style.setProperty("opacity", 0);
            setTimeout(function(mini){ mini.style.setProperty("display", "none"); }, 200, mini);
        }
    });
}

let charsSorted = {};
//sort chars
function sortCharacters()
{
    let charsTemp = {};
    for (let expansionName in chars)
    {
        let expansion = chars[expansionName];

        for (let charName in expansion)
        {
            charsTemp[charName] = expansion[charName];
        }
    }
    charsSorted = {};
    Object.keys(charsTemp).sort().forEach(function(key) { charsSorted[key] = charsTemp[key]; });
}

function displayCharacterDescription(event)
{
    let description = document.querySelector(".characterSelectorDescription");
    description.style.setProperty("display", "block");
    description.innerHTML = charsSorted[event.target.getAttribute("name")].description;
}

function removeCharacterDescription(event)
{
    let description = document.querySelector(".characterSelectorDescription");
    description.style.setProperty("display", "none");
}

function openCharacterSelector()
{
    let characterSelector = document.createElement("div");
    characterSelector.className = "characterSelector";

    //character name search input field
    let nameSearchLabel = document.createElement("div");
    nameSearchLabel.className = "nameSearchLabel";
    nameSearchLabel.textContent = "Search character name:";

    let nameSearchInput = document.createElement("input");
    nameSearchInput.className = "nameSearchInput";
    nameSearchInput.type = "text";
    nameSearchInput.addEventListener("keyup", searchCharacterName);

    let characterPicker = document.createElement("div");
    characterPicker.className = "characterPicker";

    //character picker scroll
    characterPicker.addEventListener("mousewheel", function(event)
    {
        characterPicker.scrollLeft += event.deltaY;
        event.preventDefault();
    });

    //create random icon
    let randomContainer = document.createElement("div");
    randomContainer.className = "charSelectorCharContainer";

    let randomName = document.createElement("div");
    randomName.className = "characterSelectorName";
    randomName.textContent = "Random";

    randomContainer.style.backgroundImage = "url(" + window.location.origin + "/assets/chars/random_c.png)";
    randomContainer.setAttribute("name", "Random");

    randomContainer.addEventListener("click", selectCharacterEvent);

    randomContainer.appendChild(randomName);
    characterPicker.appendChild(randomContainer);

    //create character icons
    for (let charName in charsSorted)
    {
        let character = charsSorted[charName];
        let charContainer = document.createElement("div");
        charContainer.className = "charSelectorCharContainer";

        let characterName = document.createElement("div");
        characterName.className = "characterSelectorName";
        characterName.textContent = charName;

        charContainer.style.backgroundImage = "url(" + window.location.origin + "/assets/chars/" + character.filePrefix + "_m.png)";
        charContainer.setAttribute("name", charName);

        charContainer.addEventListener("click", selectCharacterEvent);
        charContainer.addEventListener("mouseover", displayCharacterDescription);
        charContainer.addEventListener("mouseout", removeCharacterDescription);

        charContainer.appendChild(characterName);
        characterPicker.appendChild(charContainer);
    }

    let charDescription = document.createElement("div");
    charDescription.className = "characterSelectorDescription";

    //character description
    //character stats filter
    //character browser
    //character sort options

    characterSelector.appendChild(nameSearchLabel);
    characterSelector.appendChild(nameSearchInput);
    characterSelector.appendChild(characterPicker);
    characterSelector.appendChild(charDescription);

    document.body.appendChild(characterSelector);
}

// set lobby slot display
function setLobbySlot(game, slotID)
{
    let gameSlot = document.createElement("div");
    gameSlot.className = "gameSlot";

    let playerName = document.createElement("div");
    playerName.className = "slotPlayerName";
    let slotPlayer = game.players[slotID]
    playerName.textContent = slotPlayer ? slotPlayer.name : "";

    let charPic = document.createElement("div");
    charPic.className = "slotCharPic";
    charPic.style.setProperty("background-image", "url(" + ((slotPlayer.char.length > 0) ? "assets/chars/" + charsSorted[slotPlayer.char].filePrefix : "assets/chars/random") + "_p.png)");
    if (player.id == slotPlayer.id)
    {
        charPic.classList.add("clickable");
        charPic.addEventListener("click", openCharacterSelector);
    }

    let charName = document.createElement("div");
    charName.className = "slotCharName";

    charName.textContent = (slotPlayer.char.length > 0) ? slotPlayer.char : "Random";
    //slot remove element
    //player name element
    //character mini element
    //character name element
    //separator bar

    gameSlot.appendChild(playerName);
    gameSlot.appendChild(charPic);
    gameSlot.appendChild(charName);

    return gameSlot;
}

function loadLobby()
{
    sortCharacters();
    //TODO
    //get game details

    //game expansions
    //game characters

    currentGameLobby = gameDetails["asdfghjkl123456789"];

    console.log(currentGameLobby);
    let gameSlotsContainer = document.querySelector(".gameSlotsContainer");


    for (var i = 0; i < currentGameLobby.slots - 1; i++)
    {
        gameSlotsContainer.appendChild(setLobbySlot(currentGameLobby, i));
    }
}

async function mainMenu()
{
    // fetchGames();
    loadLobby();

}

mainMenu();
/*
login
display open games
create game
    select expansion characters
    select expansion cards/board
    game password
    remove player from the game
join selected game
select character
load board
    shuffle cards
    place decks
    place characters
character setup round
    draw spells
    pick items
    assign fate

game
    turn order
    turn counter
    roll
        add/substract points
        dice
            roll movement
            roll against space
            roll against card
            roll against monster
            roll against event
    give to player
        possession
            item
            trophy
            follower
            token
            spell
    move character to space
    draw card from top
    select particular hard
    browse x
        take from browsed group
        discard from browsed group
        place on top
        place on bottom
    show cards on space
    select inner board alternatives
        dragon realm
        dragon tower
*/
</script>
</html>
